From c0c3a77c8dc847f9388f80f1d8eb00d33cc8ac86 Mon Sep 17 00:00:00 2001
From: egg82 <eggys82@gmail.com>
Date: Thu, 8 Aug 2019 14:12:48 -0600
Subject: [PATCH] Add root/admin user detection

This patch detects whether or not the server is currently executing as a privileged user and spits out a warning.
The warning serves as a sort-of PSA for newer server admins who don't understand the risks of running as root.
We've seen plenty of bad/malicious plugins hit markets, and there's been a few close-calls with exploits in the past.
Hopefully this helps mitigate some potential damage to servers, even if it is just a warning.

diff --git a/src/main/java/com/destroystokyo/paper/util/ServerEnvironment.java b/src/main/java/com/destroystokyo/paper/util/ServerEnvironment.java
new file mode 100644
index 000000000..6364ea403
--- /dev/null
+++ b/src/main/java/com/destroystokyo/paper/util/ServerEnvironment.java
@@ -0,0 +1,36 @@
+package com.destroystokyo.paper.util;
+
+import java.io.OutputStream;
+import java.io.PrintStream;
+import java.util.prefs.Preferences;
+
+public class ServerEnvironment {
+    private static final boolean runningAsRootOrAdmin;
+
+    static {
+        // https://stackoverflow.com/a/23538961
+        Preferences prefs = Preferences.systemRoot();
+        PrintStream err = System.err;
+        synchronized (err) { // Synchronized to prevent swapping back to "err" before printing the warning from the try/catch to console
+            System.setErr(new PrintStream(new OutputStream() {
+                @Override
+                public void write(int b) { }
+            }));
+
+            boolean retVal;
+            try {
+                prefs.put("foo", "bar"); // SecurityException
+                prefs.remove("foo");
+                prefs.flush(); // BackingStoreException
+                retVal = true;
+            } catch (Exception ignored) { // Windows = SecurityException, Linux = BackingStoreException
+                retVal = false;
+            }
+            runningAsRootOrAdmin = retVal;
+
+            System.setErr(err);
+        }
+    }
+
+    public static boolean userIsRootOrAdmin() { return runningAsRootOrAdmin; }
+}
diff --git a/src/main/java/org/bukkit/craftbukkit/Main.java b/src/main/java/org/bukkit/craftbukkit/Main.java
index 1fa81904d..9dd236054 100644
--- a/src/main/java/org/bukkit/craftbukkit/Main.java
+++ b/src/main/java/org/bukkit/craftbukkit/Main.java
@@ -1,5 +1,6 @@
 package org.bukkit.craftbukkit;
 
+import com.destroystokyo.paper.util.ServerEnvironment; // Paper
 import java.io.File;
 import java.io.IOException;
 import java.text.SimpleDateFormat;
@@ -7,7 +8,6 @@ import java.util.Arrays;
 import java.util.Calendar;
 import java.util.Date;
 import java.util.List;
-import java.util.concurrent.TimeUnit;
 import java.util.logging.Level;
 import java.util.logging.Logger;
 import joptsimple.OptionParser;
@@ -211,6 +211,16 @@ public class Main {
                     System.setProperty(TerminalConsoleAppender.JLINE_OVERRIDE_PROPERTY, "false"); // Paper
                 }
 
+                // Paper start - detect running as root
+                if (ServerEnvironment.userIsRootOrAdmin()) {
+                    System.err.println("****************************");
+                    System.err.println("YOU ARE RUNNING AS AN ADMINISTRATIVE OR ROOT USER. THIS IS NOT ADVISED.");
+                    System.err.println("YOU ARE OPENING YOURSELF UP TO POTENTIAL RISKS WHEN DOING THIS.");
+                    System.err.println("MALWARE, BAD PLUGINS, AND ATTACKERS WILL HAVE COMPLETE ACCESS AND CONTROL OF YOUR MACHINE.");
+                    System.err.println("****************************" + System.lineSeparator());
+                }
+                // Paper end
+
                 if (Main.class.getPackage().getImplementationVendor() != null && System.getProperty("IReallyKnowWhatIAmDoingISwear") == null) {
                     Date buildDate = new SimpleDateFormat("yyyyMMdd-HHmm").parse(Main.class.getPackage().getImplementationVendor());
 
-- 
2.22.0.windows.1

